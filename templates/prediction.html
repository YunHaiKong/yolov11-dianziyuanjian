{% extends "base.html" %}

{% block title %}模型预测 - YOLO电子元件检测系统{% endblock %}

{% block page_title %}模型预测{% endblock %}

{% block content %}
<div class="row">
    <!-- 预测配置 -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-cog"></i> 预测配置</h5>
            </div>
            <div class="card-body">
                <form id="prediction-form" enctype="multipart/form-data">
                    <!-- 模型选择 -->
                    <div class="mb-3">
                        <label for="model-select" class="form-label">选择模型</label>
                        <select class="form-select" id="model-select" name="model_path" required>
                            <option value="">请选择模型...</option>
                            {% for model in models %}
                            <option value="{{ model.path }}">{{ model.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- 图片上传 -->
                    <div class="mb-3">
                        <label for="image-upload" class="form-label">上传图片</label>
                        <input type="file" class="form-control" id="image-upload" name="image" 
                               accept="image/*" required onchange="previewImage(this)">
                        <div class="form-text">支持 JPG, PNG, BMP 格式，最大 16MB</div>
                    </div>
                    
                    <!-- 图片预览 -->
                    <div class="mb-3" id="image-preview" style="display: none;">
                        <label class="form-label">图片预览</label>
                        <div class="text-center">
                            <img id="preview-img" class="img-fluid rounded" style="max-height: 200px;">
                        </div>
                    </div>
                    
                    <!-- 预测参数 -->
                    <div class="mb-3">
                        <label for="confidence" class="form-label">置信度阈值</label>
                        <input type="range" class="form-range" id="confidence" min="0.1" max="1" step="0.05" value="0.25">
                        <div class="d-flex justify-content-between">
                            <small>0.1</small>
                            <small id="confidence-value">0.25</small>
                            <small>1.0</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="iou" class="form-label">IoU阈值</label>
                        <input type="range" class="form-range" id="iou" min="0.1" max="1" step="0.05" value="0.45">
                        <div class="d-flex justify-content-between">
                            <small>0.1</small>
                            <small id="iou-value">0.45</small>
                            <small>1.0</small>
                        </div>
                    </div>
                    
                    <!-- 预测按钮 -->
                    <button type="submit" class="btn btn-primary w-100" id="predict-btn">
                        <i class="fas fa-search"></i> 开始预测
                    </button>
                </form>
            </div>
        </div>
        
        <!-- 检测统计 -->
        <div class="card mt-4" id="detection-stats" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-chart-bar"></i> 检测统计</h5>
            </div>
            <div class="card-body">
                <div id="stats-content">
                    <!-- 动态生成统计内容 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 预测结果 -->
    <div class="col-lg-8">
        <div id="prediction-results">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">选择模型并上传图片开始预测</h5>
                    <p class="text-muted">支持检测聚酯电容、热敏电阻、三极管等电子元件</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预测历史 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-history"></i> 预测历史</h5>
            </div>
            <div class="card-body">
                <div id="prediction-history">
                    <p class="text-muted text-center">暂无预测历史</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let predictionHistory = [];

$(document).ready(function() {
    // 置信度滑块事件
    $('#confidence').on('input', function() {
        $('#confidence-value').text($(this).val());
    });
    
    // IoU滑块事件
    $('#iou').on('input', function() {
        $('#iou-value').text($(this).val());
    });
    
    // 表单提交事件
    $('#prediction-form').on('submit', function(e) {
        e.preventDefault();
        performPrediction();
    });
    
    // 加载预测历史
    loadPredictionHistory();
});

function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            $('#preview-img').attr('src', e.target.result);
            $('#image-preview').show();
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function performPrediction() {
    const formData = new FormData($('#prediction-form')[0]);
    const confidence = $('#confidence').val();
    const iou = $('#iou').val();
    
    // 添加参数
    formData.append('confidence', confidence);
    formData.append('iou', iou);
    
    // 显示加载状态
    $('#predict-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 预测中...');
    
    $('#prediction-results').html(`
        <div class="card">
            <div class="card-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">预测中...</span>
                </div>
                <p class="mt-2">正在分析图片，请稍候...</p>
            </div>
        </div>
    `);
    
    $.ajax({
        url: '/api/predict',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            displayPredictionResults(response);
            addToPredictionHistory(response);
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : '预测失败';
            $('#prediction-results').html(`
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h5 class="text-danger">预测失败</h5>
                        <p class="text-muted">${error}</p>
                    </div>
                </div>
            `);
        },
        complete: function() {
            $('#predict-btn').prop('disabled', false).html('<i class="fas fa-search"></i> 开始预测');
        }
    });
}

function displayPredictionResults(response) {
    if (!response.success) {
        return;
    }
    
    const detections = response.detections || [];
    const totalDetections = response.total_detections || 0;
    
    // 显示预测结果
    const resultsHtml = `
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-check-circle text-success"></i> 
                    预测完成 (检测到 ${totalDetections} 个目标)
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>原始图片</h6>
                        <img src="/static/${response.original_image}" class="img-fluid rounded mb-3" 
                             style="cursor: pointer;" onclick="showImageModal('/static/${response.original_image}', '原始图片')">
                    </div>
                    <div class="col-md-6">
                        <h6>检测结果</h6>
                        <img src="/static/${response.result_image}" class="img-fluid rounded mb-3" 
                             style="cursor: pointer;" onclick="showImageModal('/static/${response.result_image}', '检测结果')">
                    </div>
                </div>
                
                ${detections.length > 0 ? `
                <div class="mt-3">
                    <h6>检测详情</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>类别</th>
                                    <th>置信度</th>
                                    <th>位置</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${detections.map(det => `
                                <tr>
                                    <td><span class="badge bg-primary">${det.class_name}</span></td>
                                    <td>${(det.confidence * 100).toFixed(1)}%</td>
                                    <td><small>(${det.bbox.map(x => Math.round(x)).join(', ')})</small></td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : '<p class="text-muted mt-3">未检测到任何目标</p>'}
            </div>
        </div>
    `;
    
    $('#prediction-results').html(resultsHtml);
    
    // 显示检测统计
    displayDetectionStats(detections);
}

function displayDetectionStats(detections) {
    if (detections.length === 0) {
        $('#detection-stats').hide();
        return;
    }
    
    // 统计各类别数量
    const classStats = {};
    detections.forEach(det => {
        classStats[det.class_name] = (classStats[det.class_name] || 0) + 1;
    });
    
    // 生成统计图表
    let statsHtml = '<div class="row">';
    Object.entries(classStats).forEach(([className, count]) => {
        const percentage = (count / detections.length * 100).toFixed(1);
        statsHtml += `
            <div class="col-12 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span>${className}</span>
                    <span class="badge bg-primary">${count}</span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar" style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    });
    statsHtml += '</div>';
    
    $('#stats-content').html(statsHtml);
    $('#detection-stats').show();
}

function addToPredictionHistory(response) {
    const historyItem = {
        timestamp: new Date().toLocaleString(),
        model: $('#model-select option:selected').text(),
        detections: response.total_detections,
        originalImage: response.original_image,
        resultImage: response.result_image
    };
    
    predictionHistory.unshift(historyItem);
    
    // 只保留最近10条记录
    if (predictionHistory.length > 10) {
        predictionHistory = predictionHistory.slice(0, 10);
    }
    
    updatePredictionHistory();
}

function updatePredictionHistory() {
    if (predictionHistory.length === 0) {
        $('#prediction-history').html('<p class="text-muted text-center">暂无预测历史</p>');
        return;
    }
    
    let historyHtml = '<div class="row">';
    predictionHistory.forEach((item, index) => {
        historyHtml += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">${item.timestamp}</small>
                            <span class="badge bg-success">${item.detections} 个目标</span>
                        </div>
                        <img src="/static/${item.resultImage}" class="img-fluid rounded mb-2" 
                             style="cursor: pointer; height: 120px; object-fit: cover; width: 100%;" 
                             onclick="showImageModal('/static/${item.resultImage}', '历史预测结果')">
                        <small class="text-muted">${item.model}</small>
                    </div>
                </div>
            </div>
        `;
    });
    historyHtml += '</div>';
    
    $('#prediction-history').html(historyHtml);
}

function loadPredictionHistory() {
    // 从localStorage加载历史记录
    const saved = localStorage.getItem('predictionHistory');
    if (saved) {
        try {
            predictionHistory = JSON.parse(saved);
            updatePredictionHistory();
        } catch (e) {
            console.error('Failed to load prediction history:', e);
        }
    }
}

function savePredictionHistory() {
    // 保存到localStorage
    try {
        localStorage.setItem('predictionHistory', JSON.stringify(predictionHistory));
    } catch (e) {
        console.error('Failed to save prediction history:', e);
    }
}

function showImageModal(imagePath, title) {
    const modal = `
        <div class="modal fade" id="imageModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${imagePath}" class="img-fluid" alt="${title}">
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除已存在的模态框
    $('#imageModal').remove();
    
    // 添加新模态框并显示
    $('body').append(modal);
    $('#imageModal').modal('show');
}

// 页面卸载时保存历史记录
$(window).on('beforeunload', function() {
    savePredictionHistory();
});
</script>
{% endblock %}